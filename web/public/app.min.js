!function(){"use strict";angular.module("apeiron",["apeiron.core"]),angular.module("apeiron.core",["ngRoute","ngResource","ui.router","ngCookies","ngSanitize","ngDialog","angular-ladda"])}();
!function(){"use strict";function t(t,e,a,r){r.setOption({style:"expand-left",spinnerSize:35,spinnerColor:"#ffffff"}),e.otherwise("/"),t.state("home",{url:"/",template:'<login-popup class="login"></login-popup>'}).state("story",{url:"/go/:chapter/:part",template:function(t){return'<story-page path="go" chapter="'+t.chapter+'" part="'+t.part+'"></story-page>'},authRequired:!0}).state("faq",{url:"/faq",template:'<about-page type="faq"></about-page>'}).state("rules",{url:"/rules",template:'<about-page type="rules"></about-page>'}).state("terms",{url:"/agreement",template:'<about-page type="terms" class="normal"></about-page>'}).state("privacy",{url:"/privacy_policy",template:'<about-page type="privacy" class="normal"></about-page>'}).state("settings",{url:"/characters",template:"<settings-page></settings-page>",authRequired:!0}).state("contact",{url:"/contact",template:"<contact-me></contact-me>"}),a.html5Mode(!0)}function e(t,e,a,r){t.initConnection(),r.onStart({},function(r){r.$to().self.authRequired&&t.userLoaded().then(function(a){a.needTerms?t.showTerms():e.getBlogInfo()},function(){a.go("home")})})}angular.module("apeiron").config(t).run(e),t.$inject=["$stateProvider","$urlRouterProvider","$locationProvider","laddaProvider"],e.$inject=["userService","navService","$state","$transitions"]}();
!function(){"use strict";function n(n){return{restrict:"A",link:function(t,i,c){t.$watch(function(n){return n.$eval(c.compile)},function(c){i.html(c),n(i.contents())(t)})}}}angular.module("apeiron").directive("compile",n),n.$inject=["$compile"]}();
!function(){"use strict";function e(){return{restrict:"A",controller:l,controllerAs:"vm",bindToController:!0,template:'<div class="radio-row"><div class="lrg-radio" ng-class="{\'checked\':vm.ngModel===1}"><input type="radio" name="button{{::vm.chr}}" ng-model="vm.ngModel" value="1"/><label ng-click="vm.updateValue(1)" class="check"><span class="inside"></span></label></div><div class="lrg-radio" ng-class="{\'checked\':vm.ngModel===2}"><input type="radio" name="button{{::vm.chr}}" ng-model="vm.ngModel" value="2"/><label ng-click="vm.updateValue(2)" class="check"><span class="inside"></span></label></div><div class="lrg-radio" ng-class="{\'checked\':vm.ngModel===3}"><input type="radio" name="button{{::vm.chr}}" ng-model="vm.ngModel" value="3"/><label ng-click="vm.updateValue(3)" class="check"><span class="inside"></span></label></div></div>',scope:{ngModel:"=",onSwitch:"&",chr:"@"}}}function l(){var e=this;e.updateValue=function(l){console.log("UPDATING",e.ngModel),e.ngModel=l,e.onSwitch({parms:{chr:e.chr,val:e.ngModel}})}}angular.module("apeiron").directive("rangeSelect",e),e.$inject=[]}();
!function(){"use strict";function e(){return{restrict:"A",controller:function(){},controllerAs:"vm",bindToController:!0,template:function(e,n){for(var l=parseInt(n.count),t="",a=0;a<l;a++)t+='<div class="lrg-radio"><input type="radio" name="'+n.name+'" ng-model="vm.ngModel" value="'+(a+1)+'"/><label class="check"><span class="inside"></span></label></div>';return'<div class="start-label">'+n.startLabel+"</div>"+t+"<div>"+n.endLabel+"</div>"},scope:{ngModel:"=",onSwitch:"&"}}}angular.module("apeiron").directive("surveyRange",e),e.$inject=[]}();
!function(){"use strict";function t(t){return t([{name:"getAccount",url:"/api/account",call:"get",method:"GET"},{name:"updateAccount",url:"/api/account/update",call:"post",method:"POST"},{name:"updateChapterBookmark",url:"/api/account/setchapter",call:"post",method:"POST"},{name:"getVote",url:"/api/account/selectedVote/:pollID",call:"get",method:"GET"},{name:"vote",url:"/api/vote",call:"post",method:"POST"},{name:"undoVote",url:"/api/undoVote",call:"post",method:"POST"},{name:"submitSurvey",url:"/api/submitSurvey",call:"post",method:"POST"}])}angular.module("apeiron").factory("accountApi",t),t.$inject=["ApiFactory"]}();
!function(){"use strict";function r(r,n){function e(e){var t={};t[e.call]=e.action?e.action:{method:e.method};var o=r(e.url,e.config,t);return e.params,function(r){var t=n.defer();return o[e.call](r).$promise.then(t.resolve,t.reject),t.promise}}return function(r){var n={};return angular.forEach(r,function(r){n["$"+r.name]=e(r)}),n}}angular.module("apeiron").factory("ApiFactory",r),r.$inject=["$resource","$q"]}();
!function(){"use strict";function t(t){return t([{name:"getBlogInfo",url:"/apeiron/info",call:"get",method:"GET"},{name:"getChapterData",url:"/apeiron/postinfo/:path/:chpt/:part",call:"get",method:"GET"},{name:"getPoll",url:"/apeiron/poll/:path/:chapter/:part",call:"get",method:"GET"}])}angular.module("apeiron").factory("storyApi",t),t.$inject=["ApiFactory"]}();
!function(){"use strict";function o(o,n){function t(n){o.location=o.location.protocol+"//"+o.location.host+n}var c=[{name:"finishSignup",url:"/auth/signup",call:"post",method:"POST"},{name:"logout",url:"/auth/logout",call:"post",method:"POST"}],i={$facebookAuth:function(){t("/auth/facebook")},$facebookConnect:function(){t("/connect/facebook")},$facebookUnlink:function(){t("/unlink/facebook")},$twitterAuth:function(){t("/auth/twitter")},$twitterConnect:function(){t("/connect/twitter")},$twitterUnlink:function(){t("/unlink/twitter")},$googleAuth:function(){t("/auth/google")},$googleConnect:function(){t("/connect/google")},$googleUnlink:function(){t("/unlink/google")}};return angular.extend(i,n(c)),i}angular.module("apeiron").factory("userAuthApi",o),o.$inject=["$window","ApiFactory"]}();
!function(){"use strict";function e(e,r,t,n){var o=e.defer();return{blogLoaded:function(){return o.promise},getBlogInfo:function(){r.$getBlogInfo().then(function(e){o.resolve({chapters:e.chapters,characters:e.characters,genderMapping:e.genderMap})},function(e){o.reject()})},getChapterData:function(t,n,o){var a=e.defer();return r.$getPoll({path:t,chapter:n,part:o}).then(function(e){a.resolve(e)},a.reject),a.promise},updateChapter:function(r,t){var o=e.defer();return r+1===t.chapter?n.$updateChapterBookmark(t).then(function(e){o.resolve(!0)},o.reject):o.resolve(!1),o.promise}}}angular.module("apeiron").service("navService",e),e.$inject=["$q","storyApi","ngDialog","accountApi"]}();
!function(){"use strict";function e(e,t,n,o,c,r){function a(e){o.$getAccount().then(function(t){i(t),e&&e()},function(e){s.reject()})}function i(t){l.data.userSet&&(s=e.defer()),s.resolve({needTerms:t.needTerms,email:t.email,characters:t.characters,chapters:t.chapters}),l.data.userSet=!!t,l.data.maxChapter=t.chapters}function u(e){console.log(e),t.open({template:'<msgpopup msg="'+e.message+'" close="closeThisDialog()"></msgpopup>',plain:!0})}var s=e.defer(),l={data:{userSet:!1,maxChapter:0},userLoaded:function(){return s.promise},initConnection:a,updateCharacters:function(t){var n=e.defer();return o.$updateAccount({characters:t}).then(function(){a(n.resolve)},function(){n.reject()}),n.promise},submitTerms:function(t){var n=e.defer();return r.$finishSignup(t).then(n.resolve,n.reject),n.promise},showTerms:function(){t.open({template:'<complete-account closefn="closeThisDialog()"></complete-account>',plain:!0,showClose:!1,closeByEscape:!1,closeByNavigation:!1,closeByDocument:!1})},fbSignup:function(){r.$facebookAuth()},googleSignup:function(){r.$googleAuth()},signout:function(){r.$logout().then(function(){c.location.reload()},function(e){u(e)})}};return l}angular.module("apeiron").service("userService",e),e.$inject=["$q","ngDialog","$state","accountApi","$window","userAuthApi"]}();
!function(){"use strict";function n(n){var e=this;e.$onInit=function(){n.userLoaded().then(function(n){e.email=n.email})}}angular.module("apeiron").component("contactMe",{controller:n,controllerAs:"vm",templateUrl:"/views/contact"}),n.$inject=["userService"]}();
!function(){"use strict";function e(e,o,t,n,a){var i=this;angular.extend(i,{open:function(e){t.open({className:"ngdialog ngdialog-theme-default dialog-wide",template:'<about-page style="overflow: auto" type="'+e+'"></about-page><div class="button-row"><button class="btn btn-primary" ng-click="closeThisDialog()">Ok</button></div>',plain:!0,showClose:!1,closeByEscape:!1,closeByNavigation:!1,closeByDocument:!1})},submit:function(){i.saveLoading=!0,o.submitTerms({termsSignup:!!i.acceptTerms,emailSignup:!!i.mailingList}).then(function(){i.saveLoading=!1,n.location.reload()},function(e){a.error(e),i.err="Error: Unable to complete account. Please contact Kai to report the issue."})}})}angular.module("apeiron").component("completeAccount",{templateUrl:"/views/login/completeAccount",controller:e,controllerAs:"vm",bindings:{closefn:"&"}}),e.$inject=["$state","userService","ngDialog","$window","$log"]}();
!function(){"use strict";function e(e,n){}angular.module("apeiron").component("loginPopup",{templateUrl:"/views/login",controller:e,controllerAs:"vm"}),e.$inject=["$state","userService"]}();
!function(){"use strict";function t(t,a,r,e){function p(t,a){for(var r=0;r<n.chapterPartList.length;r++)if(n.chapterPartList[r].chapter===t&&n.chapterPartList[r].part==a)return void(n.currentChapterModel=n.chapterPartList[r])}var n=this;angular.extend(n,{path:"go",data:t.data,chapterData:[],getCurrentChapter:function(){return r.chapter?(n.chapter=r.chapter,n.lastChapter=r.chapter):n.chapter=n.lastChapter,r.part?(n.part=r.part,n.lastPart=r.part):n.part=n.lastPart,"Chapter "+n.chapter+"("+n.part+")"},next:function(){a.blogLoaded().then(function(t){var a,n,c=parseInt(r.chapter),h=parseInt(r.part);h===t.chapters.go[c].parts?(n=c+1,a=1):(n=c,a=h+1),p(n,a),e.go("story",{chapter:n,part:a})})},prev:function(){a.blogLoaded().then(function(t){var a,n,c=parseInt(r.chapter),h=parseInt(r.part);if(h>1)a=c,n=h-1;else if(1===h&&0!==c){var o=t.chapters.go[c-1];a=o.chapter,n=o.parts}p(a,n),e.go("story",{chapter:a,part:n})})},goToPage:function(t){e.go("story",{chapter:n.currentChapterModel.chapter,part:n.currentChapterModel.part})},hasNext:function(){if(n.chapterData){var t=parseInt(r.chapter),a=parseInt(r.part),e=n.chapterData[n.chapterData.length-1];return!!e&&(a<e.parts||e.chapter!==t)}return!1},hasPrevious:function(){var t=parseInt(r.chapter),a=parseInt(r.part);return!(0===t&&1===a)},fbSignup:t.fbSignup,googleSignup:t.googleSignup,logout:t.signout}),n.$onInit=function(){a.blogLoaded().then(function(t){var a,e=parseInt(r.chapter),p=parseInt(r.part);n.chapterPartList=[],n.chapterData=t.chapters.go;for(var c=n.chapterData.length-1;c>=0;c--)for(var h=n.chapterData[c],o=h.parts;o>0;o--)n.chapterPartList.push({chapter:h.chapter,part:o}),h.chapter===e&&o===p&&(a=n.chapterPartList.length-1);n.currentChapterModel=n.chapterPartList[a]})}}angular.module("apeiron").component("navbar",{templateUrl:"/views/navbar",controller:t,controllerAs:"vm"}),t.$inject=["userService","navService","$stateParams","$state"]}();
!function(){"use strict";function n(n,e,a){var t=this,o={};angular.extend(t,{saveLoading:!1,noChanges:function(){return Object.keys(o).length!==Object.keys(t.charList).length},saveChar:function(n){o[n.chr]=n.val},saveChanges:function(){t.saveLoading=!0,a.userLoaded().then(function(e){a.updateCharacters(o).then(function(){t.closefn(),n.reload()})})},randomize:function(){angular.forEach(t.charList,function(n){n.val=Math.floor(3*Math.random())+1,o[n.key]=n.val})}}),t.$onInit=function(){t.saveLoading=!1}}angular.module("apeiron").component("newcharDialog",{templateUrl:"/views/newchars",controller:n,controllerAs:"vm",bindings:{charList:"<",closefn:"&"}}),n.$inject=["$state","navService","userService"]}();
!function(){"use strict";function e(e,t){function n(e){if("survey"===e.ptype)return s.pollText=e.text,"survey";var t=new Date,n=e.extend?e.extend+d:d,a=new Date(e.start),r=o(a,n),l=o(a,n+p);return s.resultDate=l.toDateString(),a<=t&&t<=r?e.active?"poll":"none":r<t&&t<=l?e.active?"pending":"none":(s.winnerIndex=e.winner,"result")}function o(e,t){var n=new Date(e);return n.setDate(n.getDate()+t),n}function a(t){e.getUserVote(t._id,t.ptype).then(function(e){s.alreadyVoted=!0,s.selectedVote=e.optionID,s.lastVoted=new Date(e.timestamp),"survey"===s.showType&&e.input.forEach(function(e,t){s.options[t].value=e.value})},function(e){s.alreadyVoted=!1,s.selectedVote=void 0})}function r(){return l(u)-l(s.lastVoted)>1}function l(e){return e.getTime()/864e5}function i(){var e=o(s.pollOptions.start,7);t.open({template:"/views/poll/recorded",controllerAs:"vm",controller:["$interval",function(t){function n(e){var t=Date.parse(e)-Date.parse(new Date),n=Math.floor(t/1e3%60),o=Math.floor(t/1e3/60%60),a=Math.floor(t/36e5%24);return{total:t,days:Math.floor(t/864e5),hours:a,minutes:o,seconds:n}}var o=this,a=t(function(){var r=n(e);o.formatTime=r.days+" days, "+r.hours+":"+r.minutes+":"+r.seconds,r.total<=0&&t.cancel(a)},1e3)}]})}var s=this,u=new Date,d=5,p=2;angular.extend(s,{selectedVote:void 0,alreadyVoted:!0,vote:function(t){s.pending=!0,e.vote(s.pollID,t).then(function(){s.pending=!1,s.alreadyVoted=!0,s.selectedVote=t,s.lastVoted=new Date,i()})},unvote:function(){s.pending=!0,e.undoVote(s.pollID,s.selectedVote).then(function(){s.pending=!1,s.alreadyVoted=!1,s.selectedVote=void 0})},canUndoVote:function(){return s.alreadyVoted&&s.lastVoted&&r()},saveChanges:function(){s.saveLoading=!0,e.submitSurvey(s.pollID,s.options).then(function(){s.saveLoading=!1,s.alreadyVoted=!0})},noChanges:function(){var e=!1;if(s.options)for(var t=0;t<s.options.length;t++)if(!s.options[t].value)return void(e=!0);return s.alreadyVoted||e}}),s.$onChanges=function(e){if(e.pollOptions&&e.pollOptions.currentValue){var t=e.pollOptions.currentValue;s.pollID=t._id,s.options=t.options,s.showType=n(t),s.showWinner||a(t)}}}angular.module("apeiron").component("apPoll",{controller:e,controllerAs:"vm",templateUrl:"/views/poll",bindings:{path:"<",chapter:"<",part:"<",pollOptions:"<"}}),e.$inject=["pollService","ngDialog"]}();
!function(){"use strict";function e(e,o,r,t,n){function i(o){l=u.pollSet?e.defer():l,u.pollSet=!0,l.resolve(o)}var l=e.defer(),u={pollSet:!1,pollLoaded:function(){return l.promise},setPoll:i,getUserVote:function(o,t){var i=e.defer();return n.userLoaded().then(function(e){r.$getVote({pollID:o,type:t}).then(function(e){e.pollID?i.resolve(e):i.reject()},function(){i.reject()})},i.reject),i.promise},vote:function(t,n){var l=e.defer();return r.$vote({pollID:t,optionID:n}).then(function(){u.pollSet=!1,i({pollID:t,optionID:n}),l.resolve()},function(e){o.error(e),l.reject()}),l.promise},undoVote:function(t,n){var l=e.defer();return r.$undoVote({pollID:t,optionID:n}).then(function(){u.pollSet=!1,i(void 0),l.resolve()},function(e){o.error(e),l.reject()}),l.promise},submitSurvey:function(t,n){var i=e.defer();return r.$submitSurvey({pollID:t,answers:n}).then(function(){i.resolve()},function(e){o.error(e),i.reject()}),i.promise}};return u}angular.module("apeiron").service("pollService",e),e.$inject=["$q","$log","accountApi","storyApi","userService"]}();
!function(){"use strict";function e(e,a,r,n){function t(){i={},a.blogLoaded().then(function(e){r.userLoaded().then(function(a){angular.forEach(a.characters,function(a,r){e.characters[r].val=a}),o.characters=e.characters,c(),o.saveLoading=!1})})}function c(e){o.filteredCharacters=n("searchFilter")(o.characters,e)}var o=this,i={};angular.extend(o,{characters:{},filteredCharacters:{},saveLoading:!1,noChanges:function(){return 0===Object.keys(i).length},clearChanges:function(){e.reload()},updateSearchFilter:c,saveChar:function(e){o.characters[e.chr].val=e.val,i[e.chr]=e.val},saveChanges:function(){o.saveLoading=!0,r.userLoaded().then(function(e){r.updateCharacters(i).then(t)})}}),o.$onInit=t}angular.module("apeiron").component("settingsPage",{templateUrl:"/views/settings",controller:e,controllerAs:"vm"}).filter("searchFilter",function(){return function(e,a){if(void 0===a)return e;var r=[];return angular.forEach(e,function(e){e.name.toLowerCase().indexOf(a.toLowerCase())>-1&&r.push(e)}),r}}),e.$inject=["$state","navService","userService","$filter"]}();
!function(){"use strict";function e(e,r){return{restrict:"A",template:'<div ng-include="vm.getActivePage()" onload="vm.updatePronouns()"></div>',link:function(n,t,a,o){function i(e,n,r){var t=e.substring(e.lastIndexOf("[")+1,e.lastIndexOf("]")-1).split("."),a=t[1][0].toUpperCase()===t[1][0],o=t[1].toLowerCase(),i=c[t[0]],u=p[o][i-1];return u?a?u[0].toUpperCase()+u.substring(1):u:""}var c,p;o.updatePronouns=function(){var n=t[0].children[0];e.userLoaded().then(function(e){r.blogLoaded().then(function(r){c=e.characters||{},p=r.genderMapping;for(var t=n.innerText,a=/(\[\[)[\w\.]+(\]\])/g,o=a.exec(t);null!=o;){var u=i(o[0],e.characters);n.innerText=n.innerText.replace(o[0],u),o=a.exec(t)}})})}},bindToController:!0,controllerAs:"vm",controller:n,scope:{path:"=",chapter:"=",part:"="}}}function n(){var e=this;angular.extend(e,{getActivePage:function(){return e.path&&e.chapter>=0&&e.part?"/apeiron/post/"+e.path+"/"+e.chapter+"/"+e.part:"/pending"}})}angular.module("apeiron").directive("pronounWrap",e),e.$inject=["userService","navService"]}();
!function(){"use strict";function t(t,a,e,n){function o(t){var e=t[t.length-1];a.go("story",{chapter:e.chapter,part:e.parts})}function r(t,a){n.userLoaded().then(function(n){var o=[];angular.forEach(t,function(t){n.characters&&n.characters[t]||o.push(a[t])}),0!==o.length&&e.open({template:'<newchar-dialog closefn="closeThisDialog()" char-list="dg.charList"></newchar-dialog>',className:"ngdialog ngdialog-theme-default dialog-wide",plain:!0,showClose:!1,closeByEscape:!1,closeByNavigation:!1,closeByDocument:!1,controllerAs:"dg",controller:[function(){this.charList=o}]})})}var c=this;angular.extend(c,{showPoll:!1}),c.$onInit=function(){n.userLoaded().then(function(a){t.blogLoaded().then(function(a){c.chapter<0||void 0===c.chapter||!c.part?o(a.chapters.go):t.getChapterData(c.path,c.chapter,c.part).then(function(t){c.chptData=t,r(t.chars,a.characters)})})})}}angular.module("apeiron").component("storyPage",{controller:t,controllerAs:"vm",templateUrl:"/views/story",bindings:{path:"@",chapter:"<",part:"<"}}),t.$inject=["navService","$state","ngDialog","userService"]}();
!function(){"use strict";function t(t,e){return"/about/"+e.type}function e(t,e){var o=this;angular.extend(o,{tags:[{text:"What is Apeiron?",anchor:"what"},{text:"Where does Apeiron take place?",anchor:"where"},{text:"How does chapter release work?",anchor:"chapter"},{text:"What is the Readship Agreement and where can I read it?",anchor:"terms"},{text:"Why pronouns?",anchor:"why"},{text:"What is a story path?",anchor:"path"},{text:"Who and what are the MC?",anchor:"mc"},{text:"What happens if there is a tie?",anchor:"ties"},{text:"What determines what voting options there are on the poll?",anchor:"questions"},{text:'Is there a "correct" option in the poll?',anchor:"correct"},{text:"How do I petition for a story rule change?",anchor:"rules"},{text:"Do you know what pronouns I've assigned the characters?",anchor:"pronouns"},{text:"Who is the author?",anchor:"author"},{text:"I discovered typos, grammar errors, lack of clarity, etc.. How can I contact you to fix them?",anchor:"errors"}],gotoAnchor:function(o){e.hash(o),t()}})}angular.module("apeiron").component("aboutPage",{templateUrl:t,controller:e,controllerAs:"vm"}),t.$inject=["$element","$attrs"],e.$inject=["$anchorScroll","$location"]}();